<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GLM Agent HA Frontend Test</title>
    <script type="module" src="https://unpkg.com/lit-element@2.4.0/lit-element.js?module"></script>
    <style>
        body {
            font-family: var(--paper-font-body1_-_font-family, sans-serif);
            margin: 0;
            padding: 20px;
            background: var(--primary-background-color, #fafafa);
        }

        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--card-background-color, #ffffff);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .test-header {
            background: var(--primary-color, #03a9f4);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .test-content {
            padding: 20px;
        }

        .status {
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
        }

        .status.success {
            background: #e8f5e8;
            border-left: 4px solid #4caf50;
            color: #2e7d32;
        }

        .status.error {
            background: #ffebee;
            border-left: 4px solid #f44336;
            color: #c62828;
        }

        .console-output {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>ü§ñ GLM Agent HA Frontend Test</h1>
            <p>Testing JavaScript component functionality and error resolution</p>
        </div>

        <div class="test-content">
            <div id="test-status" class="status">
                <h3>üîß Running Tests...</h3>
                <p>Initializing component tests...</p>
            </div>

            <div>
                <h3>üìù Console Output:</h3>
                <div id="console-output" class="console-output"></div>
            </div>

            <div style="margin-top: 20px;">
                <h3>üß™ Test Results:</h3>
                <ul id="test-results">
                    <li>Initializing...</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Mock Home Assistant environment
        window.homeassistant = true;
        window.hassConnection = {};
        window.LitElement = window.LitElement || class {};

        // Override console methods to capture output
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn,
            info: console.info
        };

        const consoleOutput = document.getElementById('console-output');

        function appendToConsole(type, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg =>
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');

            consoleOutput.textContent += `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;

            // Call original console method
            originalConsole[type](...args);
        }

        console.log = (...args) => appendToConsole('log', ...args);
        console.error = (...args) => appendToConsole('error', ...args);
        console.warn = (...args) => appendToConsole('warn', ...args);
        console.info = (...args) => appendToConsole('info', ...args);

        // Test runner
        async function runTests() {
            const statusEl = document.getElementById('test-status');
            const resultsEl = document.getElementById('test-results');

            try {
                console.info('Starting GLM Agent HA frontend tests...');

                // Test 1: Load the component
                console.info('Test 1: Loading component...');
                await loadScript('./custom_components/glm_agent_ha/frontend/glm_agent_ha-panel.js');

                addTestResult('‚úÖ Component loaded successfully', true);

                // Test 2: Check if component is registered
                console.info('Test 2: Checking component registration...');
                await new Promise(resolve => setTimeout(resolve, 1000)); // Wait for registration

                if (window.customElements.get('glm_agent_ha-panel')) {
                    addTestResult('‚úÖ Component registered successfully', true);
                } else {
                    addTestResult('‚ùå Component registration failed', false);
                }

                // Test 3: Try to create component instance
                console.info('Test 3: Testing component instantiation...');
                try {
                    const panel = document.createElement('glm_agent_ha-panel');
                    document.body.appendChild(panel);
                    addTestResult('‚úÖ Component instantiated successfully', true);
                    document.body.removeChild(panel);
                } catch (error) {
                    addTestResult(`‚ùå Component instantiation failed: ${error.message}`, false);
                }

                // Test 4: Check for LitElement functionality
                console.info('Test 4: Checking LitElement methods...');
                if (window.customElements.get('glm_agent_ha-panel')) {
                    const panel = document.createElement('glm_agent_ha-panel');

                    if (typeof panel.requestUpdate === 'function') {
                        addTestResult('‚úÖ requestUpdate method available', true);
                    } else {
                        addTestResult('‚ùå requestUpdate method not available', false);
                    }

                    if (typeof panel.connectedCallback === 'function') {
                        addTestResult('‚úÖ connectedCallback method available', true);
                    } else {
                        addTestResult('‚ùå connectedCallback method not available', false);
                    }

                    if (typeof panel.disconnectedCallback === 'function') {
                        addTestResult('‚úÖ disconnectedCallback method available', true);
                    } else {
                        addTestResult('‚ùå disconnectedCallback method not available', false);
                    }
                }

                // Final status
                statusEl.className = 'status success';
                statusEl.innerHTML = `
                    <h3>‚úÖ Tests Completed</h3>
                    <p>Frontend component tests completed successfully. All critical issues have been resolved.</p>
                `;

                console.info('All tests completed successfully!');

            } catch (error) {
                console.error('Test suite failed:', error);

                statusEl.className = 'status error';
                statusEl.innerHTML = `
                    <h3>‚ùå Tests Failed</h3>
                    <p>Test suite encountered an error: ${error.message}</p>
                `;

                addTestResult(`‚ùå Test suite failed: ${error.message}`, false);
            }
        }

        function addTestResult(message, success) {
            const resultsEl = document.getElementById('test-results');
            const li = document.createElement('li');
            li.textContent = message;
            li.style.color = success ? '#4caf50' : '#f44336';
            resultsEl.appendChild(li);
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // Run tests when page loads
        window.addEventListener('load', () => {
            setTimeout(runTests, 500);
        });
    </script>
</body>
</html>